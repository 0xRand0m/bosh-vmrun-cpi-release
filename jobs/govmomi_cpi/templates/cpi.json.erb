<%=
  params = {
    "cloud" => {
      "plugin" => "vsphere",
      "properties" => {
        "vcenters" => [
          {
            "host" => p('vcenter.address'),
            "user" => p('vcenter.user'),
            "password" => p('vcenter.password'),
            "datacenters" => []
          }
        ],
        "agent" => {
          "ntp" => p('ntp')
        }
      }
    }
  }

  params["cloud"]["properties"]["vcenters"].each do |vcenter|
    p('vcenter.datacenters').each do |datacenter|
      datacenter_hash = {
        "name" => datacenter['name'],
        "vm_folder" => datacenter['vm_folder'] || "BOSH_VMs",
        "template_folder" => datacenter['template_folder'] || "BOSH_Templates",
        "disk_path" => datacenter['disk_path'] || "BOSH_Disks",
        "datastore_pattern" => datacenter['datastore_pattern']
      }

      vcenter["datacenters"] << datacenter_hash
    end
  end

  params["cloud"]["properties"]["agent"]["blobstore"] = {
    "provider" => "local",
    "options" => {
      "blobstore_path" => p('blobstore.path')
    }
  }

  if_p('agent.mbus') do |mbus|
    params["cloud"]["properties"]["agent"]["mbus"] = mbus
  end.else_if_p('nats') do
    params["cloud"]["properties"]["agent"]["mbus"] = "nats://#{p('nats.user')}:#{p('nats.password')}@#{p(['agent.nats.address', 'nats.address'])}:#{p('nats.port')}"
  end

  JSON.dump(params)
%>
